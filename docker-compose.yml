version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: abipesca-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      NAUTH_DB_PASSWORD: ${NAUTH_DB_PASSWORD}
      NNEWS_DB_PASSWORD: ${NNEWS_DB_PASSWORD}
      BAZZUCA_DB_PASSWORD: ${BAZZUCA_DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    networks:
      - abipesca-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  ntools-api:
    build:
      context: ./NTools.API
      dockerfile: Dockerfile
    container_name: abipesca-ntools-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ChatGPT__ApiKey=${CHATGPT_APIKEY}
      - ChatGPT__ApiUrl=${CHATGPT_APIURL}
      - ChatGPT__Model=${CHATGPT_MODEL}
      - ChatGPT__ImageApiUrl=${CHATGPT_IMAGEAPIURL}
      - MailerSend__MailSender=${MAILERSEND__MAILSENDER}
      - MailerSend__ApiURL=${MAILERSEND__APIURL}
      - MailerSend__ApiToken=${MAILERSEND__APITOKEN}
      - S3__AccessKey=${S3__ACCESSKEY}
      - S3__SecretKey=${S3__SECRETKEY}
      - S3__Endpoint=${S3__ENDPOINT}
    networks:
      - abipesca-network

  nauth-api:
    build:
      context: ./NAuth.API
      dockerfile: Dockerfile
    container_name: abipesca-nauth-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__NAuthContext=Host=postgres;Port=5432;Database=nauth_db;Username=nauth_user;Password=${NAUTH_DB_PASSWORD}
      - NAuth__JwtSecret=${JWT_SECRET}
      - NTools__ApiUrl=http://ntools-api:80
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - abipesca-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 15s
      retries: 3

  nnews-api:
    build:
      context: ./NNews.API
      dockerfile: NNews.API.Dockerfile
    container_name: abipesca-nnews-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__NNewsContext=Host=postgres;Port=5432;Database=nnews_db;Username=nnews_user;Password=${NNEWS_DB_PASSWORD}
      - NAuth__JwtSecret=${JWT_SECRET}
      - NTools__ApiUrl=http://ntools-api:80
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - abipesca-network

  bazzuca-api:
    build:
      context: ./BazzucaMedia
      dockerfile: BazzucaAPI.Dockerfile
    container_name: abipesca-bazzuca-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__BazzucaContext=Host=postgres;Port=5432;Database=bazzuca_db;Username=bazzuca_user;Password=${BAZZUCA_DB_PASSWORD}
      - NAuth__JwtSecret=${JWT_SECRET}
      - NTools__ApiUrl=http://ntools-api:80
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - abipesca-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:alpine
    container_name: abipesca-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./admin/dist:/usr/share/nginx/html:ro
    depends_on:
      - nauth-api
      - nnews-api
      - bazzuca-api
    networks:
      - abipesca-network

volumes:
  postgres_data:
    driver: local

networks:
  abipesca-network:
    name: abipesca-network
    driver: bridge
