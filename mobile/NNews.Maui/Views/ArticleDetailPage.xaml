<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:NNews.Maui.ViewModels"
             xmlns:converters="clr-namespace:NNews.Maui.Converters"
             xmlns:dtos="clr-namespace:NNews.DTO;assembly=NNews.DTO"
             x:Class="NNews.Maui.Views.ArticleDetailPage"
             x:DataType="viewmodels:ArticleDetailViewModel"
             Title="Detalhes do Artigo">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:DateTimeConverter x:Key="DateTimeConverter" />
            <converters:HtmlWebViewSourceConverter x:Key="HtmlConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Compartilhar"
                     Command="{Binding ShareCommand}"
                     IconImageSource="share.png" />
    </ContentPage.ToolbarItems>

    <Grid>
        <ScrollView>
            <StackLayout Spacing="0">
                <!-- Hero Image -->
                <Image Aspect="AspectFill"
                       HeightRequest="250">
                    <Image.Source>
                        <UriImageSource Uri="{Binding Article.ImageName}"
                                       CacheValidity="7"
                                       CachingEnabled="True" />
                    </Image.Source>
                </Image>

                <!-- Content Container -->
                <StackLayout Padding="16" Spacing="16" BackgroundColor="White">
                    <!-- Title -->
                    <Label Text="{Binding Article.Title}"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="#212529"
                           LineBreakMode="WordWrap" />

                    <!-- Metadata -->
                    <Grid Margin="0,8,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackLayout Grid.Column="0" Spacing="4">
                            <Label FontSize="14" TextColor="#6C757D">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="Publicado em: " />
                                        <Span Text="{Binding Article.DateAt, Converter={StaticResource DateTimeConverter}, ConverterParameter='dd/MM/yyyy HH:mm'}"
                                              FontAttributes="Bold" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>

                            <Label Text="{Binding Article.Category.Title}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#0066CC">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding CategorySelectedCommand}" />
                                </Label.GestureRecognizers>
                            </Label>
                        </StackLayout>
                    </Grid>

                    <!-- Separator -->
                    <BoxView HeightRequest="1"
                            Color="#DEE2E6"
                            Margin="0,8" />

                    <!-- Tags -->
                    <FlexLayout Wrap="Wrap"
                               JustifyContent="Start"
                               AlignItems="Start"
                               BindableLayout.ItemsSource="{Binding Article.Tags}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="dtos:TagInfo">
                                <Frame Padding="10,6"
                                       Margin="0,0,8,8"
                                       CornerRadius="16"
                                       BackgroundColor="#E9ECEF"
                                       HasShadow="False">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ArticleDetailViewModel}}, Path=TagSelectedCommand}"
                                                            CommandParameter="{Binding .}" />
                                    </Frame.GestureRecognizers>
                                    <Label Text="{Binding Title}"
                                           FontSize="14"
                                           TextColor="#495057" />
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>

                    <!-- Content -->
                    <WebView x:Name="ContentWebView"
                             Source="{Binding HtmlContent, Converter={StaticResource HtmlConverter}}"
                             VerticalOptions="Start"
                             HorizontalOptions="FillAndExpand" />
                </StackLayout>
            </StackLayout>
        </ScrollView>

        <!-- Loading Overlay -->
        <Grid IsVisible="{Binding IsBusy}"
              BackgroundColor="#80000000">
            <ActivityIndicator IsRunning="True"
                             Color="White"
                             WidthRequest="50"
                             HeightRequest="50"
                             HorizontalOptions="Center"
                             VerticalOptions="Center" />
        </Grid>
    </Grid>
</ContentPage>
